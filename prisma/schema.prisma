generator client {
  provider   = "prisma-client"
  output     = "../src/generated/prisma"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String  @id @default(uuid()) @db.Uuid
  email          String  @unique @db.VarChar(255)
  username       String  @db.VarChar(64)
  hashedPassword String  @map("hashed_password")
  publicKey      String? @map("public_key")

  userProfile      UserProfile?
  //sentFriendRequest     FriendList[] @relation("RequestingUser")
  //receivedFriendRequest     FriendList[] @relation("BefriendedUser")
  userBlocker      BlockedList[]       @relation("UserBlocker")
  blockedFromUsers BlockedList[]       @relation("UserBlocked")
  chats            ChatParticipation[]
  chatsDeleted     ChatDeletion[]
  messages         Message[]
  images           Image[]

  @@map("user_account")
}

model UserProfile {
  user   User   @relation(fields: [userId], references: [id])
  userId String @id @map("user_id") @db.Uuid

  status      Status    @default(OFFLINE)
  name        String?   @db.VarChar(32)
  surname     String?   @db.VarChar(32)
  description String?   @db.VarChar(512)
  birthDate   DateTime? @map("birth_date") @db.Date

  @@map("user_profile")
}

/**
 * model FriendList {
 * requester             User   @relation("RequestingUser", fields: [requestingUserId], references: [id])
 * requestingUserId String @map("user_id") @db.Uuid
 * receiver            User   @relation("BefriendedUser", fields: [befriendedUserId], references: [id])
 * befriendedUserId String @map("befriended_user_id") @db.Uuid
 * @@id([requestingUserId, befriendedUserId])
 * @@map("friend_list")
 * }
 */

model BlockedList {
  blocker       User   @relation("UserBlocker", fields: [blockerUserId], references: [id])
  blockerUserId String @map("user_id") @db.Uuid

  blocked       User   @relation("UserBlocked", fields: [blockedUserId], references: [id])
  blockedUserId String @map("blocked_user_id") @db.Uuid

  @@id([blockerUserId, blockedUserId])
  @@map("blocked_list")
}

model Chat {
  id   String   @id @default(uuid()) @db.Uuid
  name String?  @db.VarChar(64)
  type ChatType

  chatParticipators ChatParticipation[]
  chatDeletions     ChatDeletion[]
  messages          Message[]
  images            Image[]

  @@map("chat")
}

model ChatParticipation {
  chat   Chat   @relation(fields: [chatId], references: [id])
  chatId String @map("chat_id") @db.Uuid

  user   User   @relation(fields: [userId], references: [id])
  userId String @map("user_id") @db.Uuid

  @@id([chatId, userId])
  @@map("chat_participation")
}

model ChatDeletion {
  chat   Chat   @relation(fields: [chatId], references: [id])
  chatId String @map("chat_id") @db.Uuid

  user   User   @relation(fields: [userId], references: [id])
  userId String @map("user_id") @db.Uuid

  @@id([chatId, userId])
  @@map("chat_deletion")
}

model Message {
  id String @id @default(uuid()) @db.Uuid

  user   User   @relation(fields: [userId], references: [id])
  userId String @map("user_id") @db.Uuid
  chat   Chat   @relation(fields: [chatId], references: [id])
  chatId String @map("chat_id") @db.Uuid

  // Will make the text propriety encrypted once the basic system works
  // encryptedText String   @map("encrypted_text")
  text      String   @map("text") @db.VarChar(4096)
  createdAt DateTime @map("created_at") @db.Timestamptz()

  @@map("message")
}

model Image {
  id String @id @default(uuid()) @db.Uuid

  user   User   @relation(fields: [userId], references: [id])
  userId String @map("user_id") @db.Uuid
  chat   Chat   @relation(fields: [chatId], references: [id])
  chatId String @map("chat_id") @db.Uuid

  uploadedAt DateTime @map("uploaded_at") @db.Timestamptz()

  @@map("image")
}

enum Status {
  ONLINE
  OFFLINE
}

enum ChatType {
  CHAT
  GROUP_CHAT
}
