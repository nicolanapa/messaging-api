generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  engineType    = "client"
  compilerBuild = "fast"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String  @id @default(uuid()) @db.Uuid
  email          String  @unique @db.VarChar(255)
  username       String  @db.VarChar(64)
  hashedPassword String  @map("hashed_password")
  publicKey      String? @map("public_key")

  userProfile UserProfile?

  sentFriendRequest                   FriendRequest[] @relation("SenderUser")
  receivedFriendRequest               FriendRequest[] @relation("ReceiverUser")
  friendListFromSentFriendRequest     FriendList[]    @relation("FirstUserFriend")
  friendListFromReceivedFriendRequest FriendList[]    @relation("SecondUserFriend")

  userBlocker      BlockedList[] @relation("UserBlocker")
  blockedFromUsers BlockedList[] @relation("UserBlocked")

  chatsParticipatingIn ChatParticipation[]
  chatsDeleted         ChatDeletion[]
  messages             Message[]
  images               Image[]

  @@map("user_account")
}

model UserProfile {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @id @map("user_id") @db.Uuid

  lastSeenOnline DateTime? @map("last_seen_online") @db.Timestamptz()
  name           String?   @db.VarChar(32)
  surname        String?   @db.VarChar(32)
  description    String?   @db.VarChar(512)
  birthDate      DateTime? @map("birth_date") @db.Date

  @@map("user_profile")
}

model FriendRequest {
  sender         User   @relation("SenderUser", fields: [senderUserId], references: [id])
  senderUserId   String @map("sender_user_id") @db.Uuid
  receiver       User   @relation("ReceiverUser", fields: [receiverUserId], references: [id])
  receiverUserId String @map("receiver_user_id") @db.Uuid

  @@id([senderUserId, receiverUserId])
  @@map("friend_request")
}

model FriendList {
  firstUser    User   @relation("FirstUserFriend", fields: [firstUserId], references: [id])
  firstUserId  String @map("first_user_id") @db.Uuid
  secondUser   User   @relation("SecondUserFriend", fields: [secondUserId], references: [id])
  secondUserId String @map("second_user_id") @db.Uuid

  @@id([firstUserId, secondUserId])
  @@map("friend_list")
}

model BlockedList {
  blocker       User   @relation("UserBlocker", fields: [blockerUserId], references: [id], onDelete: Cascade)
  blockerUserId String @map("user_id") @db.Uuid

  blocked       User   @relation("UserBlocked", fields: [blockedUserId], references: [id], onDelete: Cascade)
  blockedUserId String @map("blocked_user_id") @db.Uuid

  @@id([blockerUserId, blockedUserId])
  @@map("blocked_list")
}

model Chat {
  id   String   @id @default(uuid()) @db.Uuid
  name String?  @db.VarChar(64)
  type ChatType

  chatParticipations ChatParticipation[]
  chatDeletions      ChatDeletion[]
  messages           Message[]
  images             Image[]

  @@map("chat")
}

model ChatParticipation {
  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId String @map("chat_id") @db.Uuid

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id") @db.Uuid

  @@id([chatId, userId])
  @@map("chat_participation")
}

model ChatDeletion {
  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId String @map("chat_id") @db.Uuid

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id") @db.Uuid

  @@id([chatId, userId])
  @@map("chat_deletion")
}

model Message {
  id String @id @default(uuid()) @db.Uuid

  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String? @map("user_id") @db.Uuid
  chat   Chat    @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId String  @map("chat_id") @db.Uuid

  // Will make the text field encrypted once the basic system works
  // encryptedText String   @map("encrypted_text")
  text      String   @map("text") @db.VarChar(4096)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@map("message")
}

model Image {
  id String @id @default(uuid()) @db.Uuid

  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String? @map("user_id") @db.Uuid
  chat   Chat    @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId String  @map("chat_id") @db.Uuid

  uploadedAt DateTime @default(now()) @map("uploaded_at") @db.Timestamptz()

  @@map("image")
}

model Session {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
}

enum ChatType {
  CHAT
  GROUP_CHAT
}
